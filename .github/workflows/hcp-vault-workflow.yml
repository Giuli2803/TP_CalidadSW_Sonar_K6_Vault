name: HashiCorp Cloud Secrets

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - vault

jobs:
  retrieve_secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Configurar variables de entorno
        env:
          HCP_CLIENT_ID: ${{ secrets.HCP_CLIENT_ID }}
          HCP_CLIENT_SECRET: ${{ secrets.HCP_CLIENT_SECRET }}
        run: |
          # Obtener el token de acceso
          HCP_API_TOKEN=$(curl --location "https://auth.idp.hashicorp.com/oauth2/token" \
          --header "Content-Type: application/x-www-form-urlencoded" \
          --data-urlencode "client_id=$HCP_CLIENT_ID" \
          --data-urlencode "client_secret=$HCP_CLIENT_SECRET" \
          --data-urlencode "grant_type=client_credentials" \
          --data-urlencode "audience=https://api.hashicorp.cloud" | jq -r .access_token)
          
          echo "HCP_API_TOKEN=${HCP_API_TOKEN}" >> $GITHUB_ENV

      - name: Obtener secretos de HashiCorp Cloud Platform y establecer variables de entorno
        env:
          HCP_API_TOKEN: ${{ env.HCP_API_TOKEN }}
        run: |
          # Obtener los secretos
          SECRETS=$(curl --location "https://api.cloud.hashicorp.com/secrets/2023-11-28/organizations/f1c85201-1eab-48e9-a362-b1c5ded77e28/projects/e1dc2e66-8db0-4699-b7cb-c8ad82a5a51d/apps/AplicacionEnC/secrets:open" \
          --request GET \
          --header "Authorization: Bearer $HCP_API_TOKEN")
          
          # Extraer el valor de "password" y "username" y establecerlos como variables de entorno
          PASSWORD_OF_VAULT=$(echo "$SECRETS" | jq -r '.secrets[] | select(.name == "password") | .static_version.value')
          USERNAME_OF_VAULT=$(echo "$SECRETS" | jq -r '.secrets[] | select(.name == "username") | .static_version.value')
          
          # Exportar las variables de entorno para los siguientes pasos
          echo "PASSWORD_OF_VAULT=${PASSWORD_OF_VAULT}" >> $GITHUB_ENV
          echo "USERNAME_OF_VAULT=${USERNAME_OF_VAULT}" >> $GITHUB_ENV

      - name: Checkout del c√≥digo
        uses: actions/checkout@v2

      - name: Compilar el programa en C con valores de secretos
        env:
            PASSWORD_OF_VAULT: ${{ env.PASSWORD_OF_VAULT }}
            USERNAME_OF_VAULT: ${{ env.USERNAME_OF_VAULT }}
        run: |
            gcc -o print_env_vars print_env_vars.c \
                -DPASSWORD_OF_VAULT="${PASSWORD_OF_VAULT}" \
                -DUSERNAME_OF_VAULT="${USERNAME_OF_VAULT}"
      - name: Subir ejecutable como artefacto
        uses: actions/upload-artifact@v3
        with:
            name: ejecutable-c
            path: ./print_env_vars 
